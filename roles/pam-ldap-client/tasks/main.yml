---
# tasks file for pam-ldap-client

- name: Install packages
  apt:
    name: ldap-utils
    state: present

- name: copy neccesary certificates and keys
  copy:
    dest: "{{ item }}"
    src: "{{ item }}"
    mode: "644"
    owner: "openldap"
    group: "openldap"
  loop:
    - "{{ CA.ca_cert_file }}"

- name: Configure this host as ldap client
  lineinfile:
      path: /etc/hosts
      state: present
      line: "{{ ldap_server_ip }} {{ ldap_server_domain }}"

- name: Configure ldap client
  lineinfile:
      path: /etc/ldap/ldap.conf
      state: present
      line: "{{ item }}"
  loop:
  - "TLS_CACERT {{ CA.ca_cert_file }}"
  - "TLS_REQ_CERT never"
  - "BASE {{ ldap_base_dn }}"
  - "URI ldaps://{{ ldap_server_domain }}"

#see debconf properties
# # cd /tmp && apt-get download libpam-ldap libnss-ldap
# Get:1 http://deb.debian.org/debian stretch/main amd64 libnss-ldap amd64 265-5 [115 kB]
# Get:2 http://deb.debian.org/debian stretch/main amd64 libpam-ldap amd64 186-4 [87.0 kB]
# # ar x libnss-ldap_265-5_amd64.deb
# # tar xvf control.tar.gz
# grep -e "^Template:" -e "^Type: " -e "^Default: " -e "^Description: " templates  | \
#    sed -e "s/Template/  - question/" -e "s/^Type/    type/" -e "s/^Default/    value/" -e "s/^Description: \(.*$\)/    description: \"\1\"/"
# - question: libnss-ldap/confperm
#   type: boolean
#   value: false
#   description: "Make the configuration file readable/writeable by its owner only?"
# - question: libnss-ldap/nsswitch
#   type: note
#   description: "nsswitch.conf not managed automatically"
# - question: shared/ldapns/base-dn
#   type: string
#   value: dc=example,dc=net
#   description: "Distinguished name of the search base:"
# - question: libnss-ldap/dblogin
#   type: boolean
#   value: false
#   description: "Does the LDAP database require login?"
# - question: libnss-ldap/override
#   type: boolean
#   value: true
#   description: "Automatically update libnss-ldap's configuration file?"
# - question: libnss-ldap/binddn
#   type: string
#   value: cn=proxyuser,dc=example,dc=net
#   description: "Unprivileged database user:"
# - question: libnss-ldap/bindpw
#   type: password
#   description: "Password for database login account:"
# - question: shared/ldapns/ldap_version
#   type: select
#   value: 3
#   description: "LDAP version to use:"
# - question: shared/ldapns/ldap-server
#   type: string
#   value: ldap://127.0.0.1/
#   description: "LDAP server Uniform Resource Identifier:"
# - question: libnss-ldap/dbrootlogin
#   type: boolean
#   value: true
#   description: "Special LDAP privileges for root?"
# - question: libnss-ldap/rootbinddn
#   type: string
#   value: cn=manager,dc=example,dc=net
#   description: "LDAP account for root:"
# - question: libnss-ldap/rootbindpw
#   type: password
#   description: "LDAP root account password:"

- name: Preconfigure package libnss-ldap
  debconf:
      name: libnss-ldap 
      value: "{{ item.value }}"
      vtype: "{{ item.type }}"
      question: "{{ item.question }}"
  loop:
  - question: libnss-ldap/confperm
    type: boolean
    value: false
    description: "Make the configuration file readable/writeable by its owner only?"
  - question: libnss-ldap/nsswitch
    type: note
    value: ""
    description: "nsswitch.conf not managed automatically"
  - question: shared/ldapns/base-dn
    type: string
    value: "{{ ldap_base_dn }}"
    description: "Distinguished name of the search base:"
  - question: libnss-ldap/dblogin
    type: boolean
    value: false
    description: "Does the LDAP database require login?"
  - question: libnss-ldap/override
    type: boolean
    value: true
    description: "Automatically update libnss-ldap's configuration file?"
  - question: libnss-ldap/binddn
    type: string
    value: "cn=admin,{{ ldap_base_dn }}"
    description: "Unprivileged database user:"
  - question: libnss-ldap/bindpw
    type: password
    value: "{{ ldap_admin_pw }}"
    description: "Password for database login account:"
  - question: shared/ldapns/ldap_version
    type: select
    value: 3
    description: "LDAP version to use:"
  - question: shared/ldapns/ldap-server
    type: string
    value: "ldaps://{{ ldap_server_domain }}/"
    description: "LDAP server Uniform Resource Identifier:"
  - question: libnss-ldap/dbrootlogin
    type: boolean
    value: true
    description: "Special LDAP privileges for root?"
  - question: libnss-ldap/rootbinddn
    type: string
    value: "cn=admin,{{ ldap_base_dn }}"
    description: "LDAP account for root:"
  - question: libnss-ldap/rootbindpw
    type: password
    value: "{{ ldap_admin_pw }}"
    description: "LDAP root account password:"

# To see questions do the same that was done for the previous one
- name: Preconfigure package libpam-ldap
  debconf:
      name: libpam-ldap 
      value: "{{ item.value }}"
      vtype: "{{ item.type }}"
      question: "{{ item.question }}"
  loop:
  - question: libpam-ldap/rootbinddn
    type: string
    value: "cn=admin,{{ ldap_base_dn }}"
    description: "LDAP administrative account:"
  - question: libpam-ldap/rootbindpw
    type: password
    value: "{{ ldap_admin_pw }}"
    description: "LDAP administrative password:"
  - question: libpam-ldap/dblogin
    type: boolean
    value: false
    description: "Does the LDAP database require login?"
  - question: shared/ldapns/base-dn
    type: string
    value: "{{ ldap_base_dn }}"
    description: "Distinguished name of the search base:"
  - question: libpam-ldap/pam_password
    type: select
    value: crypt
    description: "Local encryption algorithm to use for passwords:"
  - question: shared/ldapns/ldap_version
    type: select
    value: 3
    description: "LDAP version to use:"
  - question: libpam-ldap/binddn
    type: string
    value: "cn=admin,{{ ldap_base_dn }}"
    description: "LDAP login user account:"
  - question: libpam-ldap/dbrootlogin
    type: boolean
    value: true
    description: "Allow LDAP admin account to behave like local root?"
  - question: shared/ldapns/ldap-server
    type: string
    value: "ldaps://{{ ldap_server_domain }}/"
    description: "LDAP server URI:"
  - question: libpam-ldap/bindpw
    type: password
    value: "{{ ldap_admin_pw }}"
    description: "Password for LDAP login user:"
  - question: libpam-ldap/override
    type: boolean
    value: true
    description: "Manage libpam-ldap configuration automatically?"

- name: Install packages
  apt:
    name: ["libnss-ldap", "libpam-ldap"]
    state: present

- name: configure nsswitch-ldap
  lineinfile:
      path: /etc/nsswitch.conf
      state: present
      regexp: "{{ item.regex }}"
      line: "{{ item.line }}"
  loop:
    - line: "passwd:         files ldap"
      regex: "^passwd"
    - line: "group:          files ldap"
      regex: "^group"
    - line: "shadow:         files ldap"
      regex: "^shadow"
    - line: "gshadow:        files ldap"
      regex: "^gshadow"
    - line: "hosts:          files ldap dns"
      regex: "^hosts"
    - line: "networks:       files ldap"
      regex: "^networks"


# see https://docs.cumulusnetworks.com/download/attachments/8362556/kb_debconf.txt?version=1&modificationDate=1537401093000&api=v2
- name: Reconfigure package libpam-runtime
  debconf:
      name: libpam-runtime
      value: "{{ item.value }}"
      vtype: "{{ item.type }}"
      question: "{{ item.question }}"
  loop:
  - question: libpam-runtime/title
    type: title
    description: "PAM configuration"
    value: ""
  - question: libpam-runtime/profiles
    type: multiselect
    description: "PAM profiles to enable:"
    value: 
  - question: libpam-runtime/conflicts
    type: error
    description: "Incompatible PAM profiles selected."
    value: "unix, ldap, mkhomedir" #ccreds-save, unix, ldap, mkhomedir , ccreds-check
  - question: libpam-runtime/override
    type: boolean
    value: false
    description: "Override local changes to /etc/pam.d/common-*?"
  - question: libpam-runtime/no_profiles_chosen
    type: error
    description: "No PAM profiles have been selected."

- name: Invoke dpkg-reconfigure to reconfigure libpam-runtime
  shell: dpkg-reconfigure libpam-runtime